<?php
 defined ( 'ADMIN_KEKE' ) or exit ( 'Access Denied' ); kekezu::admin_check_role (32); $ad_obj = new Keke_witkey_ad_class (); $tag_obj = new Keke_witkey_tag_class (); $order_type and $order_type=$order_type or $order_type ='one'; $w [page_size] and $page_size = intval ( $w [page_size] ) or $page_size = 10; $page and $page = intval ( $page ) or $page = '1'; $url = "index.php?do=$do&view=$view&order_type=$order_type&w[tpl_type]=$w[tpl_type]&w[page_size]=$page_size&w[ord]=$w[ord]&page=$page"; if (isset ( $ac )) { if ($delid) { switch ($order_type) { case "one" : $ad_obj->setWhere ( 'ad_id=' . $delid ); $res = $ad_obj->del_keke_witkey_ad (); $res and kekezu::admin_system_log ( $_lang['delete_ad'].$delid ); break; case "group" : $ad_name = db_factory::get_count ( "select tagname from " . TABLEPRE . "witkey_tag where tag_id = '$delid'" ); $ad_obj->setWhere ( "ad_name='$ad_name'" ); $res = $ad_obj->del_keke_witkey_ad (); $tag_obj->setWhere ( 'tag_id=' . $delid ); $res and kekezu::admin_system_log ( $_lang['delete_ad_tag'].$ad_name ); $res = $tag_obj->del_keke_witkey_tag (); break; } if ($res) { kekezu::admin_system_log ( $_lang['delete_ad'].$delid ); kekezu::admin_show_msg ( $_lang['delete_success'], $url,3,'','success'); } else { kekezu::admin_show_msg ( $_lang['delete_fail'],$url,3,'','warning'); } } else { kekezu::admin_show_msg ( $_lang['ad_not_exists'],$url,3,'','warning'); } }elseif(isset($sbt_action)){ $ckb_string = $ckb; is_array ( $ckb_string ) and $ckb_string = implode ( ',', $ckb_string ); if (count ( $ckb_string )) { switch ($sbt_action) { case $_lang['mulit_delete'] : if ($order_type == 'one') { $ad_obj->setWhere ( ' ad_id in (' . $ckb_string . ') ' ); $res = $ad_obj->del_keke_witkey_ad (); } else if ($order_type == 'group') { $tag_name_arr = db_factory::query ( " select tagname from " . TABLEPRE . "witkey_tag where tag_id in($ckb_string) " ); foreach ( $tag_name_arr as $v ) { $ad_obj->setWhere ( " ad_name = '$v[tagname]' " ); $res = $ad_obj->del_keke_witkey_ad (); } $tag_obj->setWhere ( 'tag_id in(' . $ckb_string . ')' ); $res .= $tag_obj->del_keke_witkey_tag (); } break; default : break; } if ($res) { kekezu::admin_system_log ( $_lang['delete_ad'].$ckb_string ); kekezu::admin_show_msg ( $_lang['mulit_operate_success'],$url,'3','','success'); } else { kekezu::admin_show_msg ( $_lang['mulit_operate_fail'],$url,3,'','warning'); } } else { kekezu::admin_show_msg ( $_lang['choose_operate_item'],$url,3,'','warning'); } } else { $template_arr = db_factory::query ( " select tpl_title from " . TABLEPRE . "witkey_template" ); $order_type == 'one' and $sql = " 1 = 1 " or $sql = " 1 = 1 and tag_type=7 "; isset ( $w[tpl_type]) and $tpl_type = $w[tpl_type] or $tpl_type = $_K [template]; $tpl_type and $sql .= " and FIND_IN_SET('$tpl_type',tpl_type) "; switch ($order_type) { case "one" : $w ['ad_id'] and $sql .= " and ad_id = '$w[ad_id]'"; $w ['ad_name'] and $sql .= " and INSTR(ad_name,'$w[ad_name]')>0 "; $w ['ord'] and $sql .= " order by $w[ord] " or $sql .= " order by ad_id desc "; $ad_obj->setWhere ( $sql ); $count = $ad_obj->count_keke_witkey_ad (); break; case "group" : $w ['tag_id'] and $sql .= " and tag_id = '$w[tag_id]'"; $w ['tagname'] and $sql .= " and INSTR(tagname,'$w[tagname]')>0 "; $w ['ord'] and $sql .= " order by $w[ord] " or $sql .= " order by tag_id desc "; $tag_obj->setWhere ( $sql ); $count = $tag_obj->count_keke_witkey_tag (); break; } $pages = kekezu::$_page_obj->getPages ( $count, $page_size, $page, $url ); if ($order_type == 'one') { $ad_obj->setWhere ( $sql . $pages [where] ); $ad_arr = $ad_obj->query_keke_witkey_ad (); } if ($order_type == 'group') { $tag_obj->setWhere ( $sql . $pages [where] ); $ad_arr = $tag_obj->query_keke_witkey_tag (); } } require kekezu::$_template->template ( 'control/admin/tpl/admin_' . $do . '_' . $view . '_' . $order_type );